apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: {{ include "falco-airgapped.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "falco-airgapped.labels" . | nindent 4 }}
spec:
  selector:
    matchLabels:
      {{- include "falco-airgapped.selectorLabels" . | nindent 6 }}
  updateStrategy:
    {{- toYaml .Values.daemonset.updateStrategy | nindent 4 }}
  template:
    metadata:
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
        {{- with .Values.daemonset.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      labels:
        {{- include "falco-airgapped.selectorLabels" . | nindent 8 }}
        {{- with .Values.daemonset.podLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "falco-airgapped.serviceAccountName" . }}
      hostNetwork: {{ .Values.daemonset.hostNetwork }}
      hostPID: {{ .Values.daemonset.hostPID }}
      {{- if .Values.daemonset.priorityClassName }}
      priorityClassName: {{ .Values.daemonset.priorityClassName }}
      {{- end }}
      {{- with .Values.daemonset.podSecurityContext }}
      securityContext:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.daemonset.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.daemonset.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.daemonset.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      
      initContainers:
      {{- if eq (include "falco-airgapped.useSidecarPluginLoader" .) "true" }}
      # Plugin loader init container (sidecar strategy)
      - name: plugin-loader
        image: {{ include "falco-airgapped.pluginLoaderImage" . }}
        imagePullPolicy: {{ .Values.pluginLoader.image.pullPolicy }}
        command:
          - /usr/local/bin/install-plugins.sh
        env:
          - name: FALCO_PLUGINS_DIR
            value: /plugins-volume
        volumeMounts:
          - name: plugins-volume
            mountPath: /plugins-volume
        {{- with .Values.pluginLoader.resources }}
        resources:
          {{- toYaml . | nindent 10 }}
        {{- end }}
      {{- end }}
      
      {{- if and .Values.driver.loader.enabled .Values.driver.loader.initContainer.enabled }}
      # Driver loader init container
      - name: driver-loader
        image: {{ include "falco-airgapped.driverLoaderImage" . }}
        imagePullPolicy: {{ .Values.driver.loader.initContainer.image.pullPolicy }}
        securityContext:
          privileged: true
        env:
          - name: DRIVER_REPO
            value: {{ .Values.driver.loader.driverRepo | default "https://download.falco.org/driver" | quote }}
        volumeMounts:
          - name: host-root
            mountPath: /host
            readOnly: true
          - name: driver-volume
            mountPath: /driver
        {{- with .Values.driver.loader.initContainer.resources }}
        resources:
          {{- toYaml . | nindent 10 }}
        {{- end }}
      {{- end }}
      
      containers:
      - name: falco
        image: {{ include "falco-airgapped.image" . }}
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        {{- with .Values.daemonset.containerSecurityContext }}
        securityContext:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        args:
          - /usr/bin/falco
          - --cri
          - /run/containerd/containerd.sock
          - --cri
          - /run/crio/crio.sock
          - -K
          - /var/run/secrets/kubernetes.io/serviceaccount/token
          - -k
          - https://$(KUBERNETES_SERVICE_HOST)
          - -pk
        env:
          - name: FALCO_BPF_PROBE
            value: ""
          {{- if eq (include "falco-airgapped.useS3PluginLoader" .) "true" }}
          # S3 plugin loader environment variables
          - name: S3_BUCKET
            value: {{ .Values.s3PluginLoader.bucket | quote }}
          - name: S3_PREFIX
            value: {{ .Values.s3PluginLoader.prefix | quote }}
          - name: AWS_REGION
            value: {{ .Values.s3PluginLoader.region | quote }}
          - name: REQUIRED_PLUGINS
            value: {{ .Values.s3PluginLoader.requiredPlugins | quote }}
          - name: PLUGIN_DOWNLOAD_TIMEOUT
            value: {{ .Values.s3PluginLoader.timeout | quote }}
          - name: FAIL_ON_PLUGIN_ERROR
            value: {{ .Values.s3PluginLoader.failOnError | quote }}
          {{- end }}
          {{- with .Values.extraEnv }}
          {{- toYaml . | nindent 10 }}
          {{- end }}
        
        {{- if .Values.livenessProbe.enabled }}
        livenessProbe:
          {{- toYaml .Values.livenessProbe.httpGet | nindent 10 }}
          initialDelaySeconds: {{ .Values.livenessProbe.initialDelaySeconds }}
          periodSeconds: {{ .Values.livenessProbe.periodSeconds }}
          timeoutSeconds: {{ .Values.livenessProbe.timeoutSeconds }}
          failureThreshold: {{ .Values.livenessProbe.failureThreshold }}
        {{- end }}
        
        {{- if .Values.readinessProbe.enabled }}
        readinessProbe:
          {{- toYaml .Values.readinessProbe.httpGet | nindent 10 }}
          initialDelaySeconds: {{ .Values.readinessProbe.initialDelaySeconds }}
          periodSeconds: {{ .Values.readinessProbe.periodSeconds }}
          timeoutSeconds: {{ .Values.readinessProbe.timeoutSeconds }}
          failureThreshold: {{ .Values.readinessProbe.failureThreshold }}
        {{- end }}
        
        {{- with .Values.resources }}
        resources:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        
        volumeMounts:
          - name: config
            mountPath: /etc/falco
          {{- if eq (include "falco-airgapped.useSidecarPluginLoader" .) "true" }}
          - name: plugins-volume
            mountPath: /usr/share/falco/plugins
            readOnly: true
          {{- end }}
          - name: host-root
            mountPath: /host
            readOnly: true
          - name: host-proc
            mountPath: /host/proc
            readOnly: true
          - name: host-dev
            mountPath: /host/dev
            readOnly: true
          - name: host-var-run
            mountPath: /host/var/run
            readOnly: true
          - name: host-run
            mountPath: /host/run
            readOnly: true
          - name: host-etc
            mountPath: /host/etc
            readOnly: true
          - name: logs
            mountPath: /var/log/falco
          {{- with .Values.extraVolumeMounts }}
          {{- toYaml . | nindent 10 }}
          {{- end }}
      
      volumes:
        - name: config
          configMap:
            name: {{ include "falco-airgapped.fullname" . }}
        {{- if eq (include "falco-airgapped.useSidecarPluginLoader" .) "true" }}
        - name: plugins-volume
          emptyDir: {}
        {{- end }}
        {{- if and .Values.driver.loader.enabled .Values.driver.loader.initContainer.enabled }}
        - name: driver-volume
          emptyDir: {}
        {{- end }}
        - name: host-root
          hostPath:
            path: /
        - name: host-proc
          hostPath:
            path: /proc
        - name: host-dev
          hostPath:
            path: /dev
        - name: host-var-run
          hostPath:
            path: /var/run
        - name: host-run
          hostPath:
            path: /run
        - name: host-etc
          hostPath:
            path: /etc
        - name: logs
          hostPath:
            path: /var/log/falco
            type: DirectoryOrCreate
        {{- with .Values.extraVolumes }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
